<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal Dashboard</title>
    <!-- Your Custom Favicon -->
    <link rel="icon" type="image/png" href="<%= basePath %>/images/favicon.png">
    <link rel="apple-touch-icon" href="<%= basePath %>/images/favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="<%= basePath %>/css/dashboard.css">
</head>
<body data-session-max-age="<%= sessionMaxAge %>" data-base-path="<%= basePath %>">
    <header class="header">
        <div class="header-content">
            <div class="welcome">
                <i class="fas fa-user-circle"></i> Welcome, <%= username %>!
            </div>
            <a href="<%= basePath %>/logout" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </header>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Checklist Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-tasks"></i> My Checklists
                    </div>
					<button class="add-btn" id="add-task-btn">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </div>

                <form id="checklist-form" class="hidden" method="POST" action="<%= basePath %>/checklist">
                    <div class="form-group">
                        <input type="text" name="title" placeholder="Enter task title..." required>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </form>

                <div class="checklist-items">
                    <% checklists.forEach(item => { %>
                        <div class="checklist-item <%= item.completed ? 'completed' : '' %>">
                            <span><%= item.title %></span>
                            <div class="item-actions">
                                <form method="POST" action="<%= basePath %>/checklist/<%= item.id %>/toggle" class="d-inline">
                                    <button type="submit" class="action-btn toggle-btn">
                                        <i class="fas fa-<%= item.completed ? 'undo' : 'check' %>"></i>
                                    </button>
                                </form>
                                <form method="POST" action="<%= basePath %>/checklist/<%= item.id %>/delete" class="d-inline">
									<button type="submit" class="action-btn delete-btn">
										<i class="fas fa-trash"></i>
									</button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                    <% if (checklists.length === 0) { %>
                        <p class="empty-state-text">
                            No tasks yet. Add your first task above!
                        </p>
                    <% } %>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-sticky-note"></i> My Notes
                    </div>
					<button class="add-btn" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>

                <form id="notes-form" class="hidden" method="POST" action="<%= basePath %>/notes">
                    <div class="form-group">
                        <input type="text" name="title" placeholder="Note title..." required>
                    </div>
                    <div class="form-group">
                        <textarea name="content" rows="3" placeholder="Note content..."></textarea>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </form>

                <div class="notes-items">
                    <% notes.forEach(note => { %>
                        <div class="note-item">
                            <div class="flex-1">
                                <div class="file-name"><%= note.title %></div>
                                <div class="note-content"><%= note.content %></div>
                                <div class="file-meta">
                                    <i class="fas fa-clock"></i> <%= new Date(note.updated_at).toLocaleDateString() %>
                                </div>
                            </div>
                            <div class="item-actions">
                                <form method="POST" action="<%= basePath %>/notes/<%= note.id %>/delete" class="d-inline">
                                    <button type="submit" class="action-btn delete-btn">
										<i class="fas fa-trash"></i>
									</button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                    <% if (notes.length === 0) { %>
                        <p class="empty-state-text">
                            No notes yet. Create your first note above!
                        </p>
                    <% } %>
                </div>
            </div>

            <!-- Files Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-folder"></i> My Files
                    </div>
					<button class="add-btn" id="add-file-btn">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>

                <form id="upload-form" class="hidden" method="POST" action="<%= basePath %>/upload" enctype="multipart/form-data">
                    <div class="upload-area">
                        <label for="file-input" class="upload-label">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            Click to select file or drag and drop
                            <input type="file" id="file-input" name="file" required>
                        </label>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-upload"></i> Upload File
                    </button>
                </form>

                <div class="files-items">
                    <% files.forEach(file => { %>
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">
                                    <i class="fas fa-file"></i> <%= file.original_name %>
                                </div>
                                <div class="file-meta">
                                    <%= Math.round(file.file_size / 1024) %> KB • 
                                    <i class="fas fa-clock"></i> <%= new Date(file.created_at).toLocaleDateString() %>
                                </div>
                            </div>
                            <div class="item-actions">
                                <a href="<%= basePath %>/download/<%= file.id %>" class="action-btn text-success">
                                    <i class="fas fa-download"></i>
                                </a>
                                <form method="POST" action="<%= basePath %>/files/<%= file.id %>/delete" class="d-inline">
                                    <button type="submit" class="action-btn delete-btn">
										<i class="fas fa-trash"></i>
									</button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                    <% if (files.length === 0) { %>
                        <p class="empty-state-text">
                            No files uploaded yet. Upload your first file above!
                        </p>
                    <% } %>
                </div>
            </div>

            <!-- Links Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-link"></i> My Links
                    </div>
					<button class="add-btn" id="add-link-btn">
                        <i class="fas fa-plus"></i> Add Link
                    </button>
                </div>

                <form id="link-form" class="hidden" method="POST" action="<%= basePath %>/links">
                    <div class="form-group">
                        <input type="text" name="title" placeholder="Link description..." required>
                    </div>
                    <div class="form-group">
                        <input type="url" name="url" placeholder="https://example.com" required>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i> Add Link
                    </button>
                </form>

                <div class="files-items"> <!-- Re-using files-items for consistent styling -->
                    <% links.forEach(link => { %>
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">
                                    <a href="<%= link.url %>" target="_blank" rel="noopener noreferrer" title="<%= link.url %>">
                                        <i class="fas fa-external-link-alt"></i> <%= link.title %>
                                    </a>
                                </div>
                                <div class="file-meta">
                                    <i class="fas fa-clock"></i> <%= new Date(link.created_at).toLocaleDateString() %>
                                </div>
                            </div>
                            <div class="item-actions">
                                <form method="POST" action="<%= basePath %>/links/<%= link.id %>/delete" class="d-inline">
                                    <button type="submit" class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                    <% if (links.length === 0) { %>
                        <p class="empty-state-text">No links saved yet. Add your first link above!</p>
                    <% } %>
                </div>
            </div>

            <!-- Profile & Reminders Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-user-cog"></i> Profile & Reminders
                    </div>
                </div>

                <!-- Profile Email Form -->
                <form method="POST" action="<%= basePath %>/profile/email" class="mb-2rem">
                    <div class="form-group">
                        <label for="email">Notification Email</label>
                        <input type="email" id="email" name="email" value="<%= userEmail || '' %>" placeholder="you@example.com" required>
                    </div>
                    <button type="submit" class="submit-btn btn-update-email">
                        <i class="fas fa-save"></i> Update Email
                    </button>
                    <% if (!userEmail) { %>
                        <p class="form-help-text">
                            Set an email to receive reminder notifications.
                        </p>
                    <% } %>
                </form>

                <hr class="divider">

                <!-- Reminders Section -->
                <div class="card-header card-header-flush">
                    <div class="card-title card-title-sm">
                        <i class="fas fa-bell"></i> Reminders
                    </div>
                    <button class="add-btn" id="add-reminder-btn">
                        <i class="fas fa-plus"></i> Add Reminder
                    </button>
                </div>

                <form id="reminder-form" class="hidden" method="POST" action="<%= basePath %>/reminders">
                    <div class="form-group">
                        <input type="text" name="title" placeholder="Reminder title..." required>
                    </div>
                    <div class="form-group">
                        <input type="datetime-local" name="remind_at" required>
                    </div>
                    <div class="form-group">
                        <select name="recurrence">
                            <option value="none">Does not repeat</option>
                            <option value="daily">Repeats Daily</option>
                            <option value="weekly">Repeats Weekly</option>
                        </select>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i> Add Reminder
                    </button>
                </form>

                <div class="reminders-items">
                    <% reminders.forEach(reminder => { %>
                        <%
                        // A non-recurring reminder is "past due" if its time has passed.
                        // Recurring reminders are never "past due" as they just reschedule.
                        const isPastDue = new Date(reminder.remind_at) < new Date() && reminder.recurrence === 'none';
                        %>
                        <div class="checklist-item <%= isPastDue ? 'completed' : '' %>"> <!-- Re-using checklist-item style -->
                            <div class="flex-1">
                                <span><%= reminder.title %></span>
                                <div class="file-meta mt-quarter">
                                    <% if (reminder.recurrence && reminder.recurrence !== 'none') { %>
                                        <i class="fas fa-sync-alt" title="Recurring"></i> 
                                        Repeats <%= reminder.recurrence.charAt(0).toUpperCase() + reminder.recurrence.slice(1) %> •
                                    <% } %>
                                    <i class="fas fa-clock"></i> 
                                    <% if (isPastDue) { %>
                                        Due: <%= new Date(reminder.remind_at).toLocaleString() %>
                                    <% } else { %>
                                        Next: <%= new Date(reminder.remind_at).toLocaleString() %>
                                    <% } %>
                                </div>
                            </div>
                            <div class="item-actions">
                                <form method="POST" action="<%= basePath %>/reminders/<%= reminder.id %>/delete" class="d-inline">
                                    <button type="submit" class="action-btn delete-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                    <% if (reminders.length === 0) { %>
                        <p class="empty-state-text-sm">
                            No upcoming reminders.
                        </p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <script src="<%= basePath %>/dashboard.js"></script>
</body>
</html>
